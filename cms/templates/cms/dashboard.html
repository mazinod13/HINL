{% extends "cms/base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row">


<!-- SYMBOL + SUMMARY + TRANSACTION TABLE -->
<main class="col-12 col-md-7">
  <div class="table-responsive">
    <table class="table table-bordered table-sm text-center align-middle small mb-0">

<thead class="fw-semibold">

  <!-- SYMBOL + SUMMARY TABLE START -->
  <tr class="table-secondary">
    <!-- SYMBOL COLUMN | colspan=2 to shift summary left -->
    <td rowspan="3" colspan="2" class="text-start align-middle" style="width: 150px; position: relative;">

      <div class="dropdown">
        <a class="dropdown-toggle text-decoration-none fw-bold text-primary" href="#" role="button" id="symbolDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="cursor: pointer;">
          {{ current_symbol }}
        </a>
        <ul class="dropdown-menu" aria-labelledby="symbolDropdown" style="max-height: 200px; overflow-y: auto;">
          {% for sym in all_symbols %}
            <li>
              <a class="dropdown-item {% if sym == current_symbol %}active{% endif %}" href="{% url 'cms:dashboard' symbol=sym %}">
                {{ sym }}
              </a>
            </li>
          {% endfor %}
        </ul>

      </div>

    </td>

    <!-- All other columns shifted left by one -->
    <td class="text-start">Closing Bal</td>
    <td class="text-end">{{ summary.closing_qty|floatformat:0 }}</td>
    <td class="text-end">{{ summary.closing_amount|floatformat:0 }}</td>
    <td class="text-end">{{ summary.closing_rate|floatformat:2 }}</td>
    <td class="text-start">Realized P/L</td>
    <td class="text-end">{{ summary.realized_profit|floatformat:2 }}</td>
    <td rowspan="2" class="align-middle fw-bold bg-light">NAV</td>
  </tr>

  <tr class="table-light small">
    <td class="text-start">Total Purchase</td>
    <td class="text-end">{{ summary.total_p_qty|floatformat:0 }}</td>
    <td class="text-end">{{ summary.total_p_amount|floatformat:0 }}</td>
    <td class="text-end">{{ summary.p_rate|floatformat:2 }}</td>
    <td class="text-start">Unrealized P/L</td>
    <td class="text-end">{{ summary.unrealized_profit|floatformat:2 }}</td>
  </tr>

  <tr class="table-light small border-bottom">
    <td class="text-start">Total Sales</td>
    <td class="text-end">{{ summary.total_s_qty|floatformat:0 }}</td>
    <td class="text-end">{{ summary.total_s_amount|floatformat:0 }}</td>
    <td class="text-end">{{ summary.s_rate|floatformat:2 }}</td>
    <td class="text-start">Total P/L</td>
    <td class="text-end fw-semibold">{{ summary.realized_profit|add:summary.unrealized_profit|floatformat:2 }}</td>
    <td class="text-end">{{ summary.nav|floatformat:2 }}</td>
  </tr>

  <!-- COLUMN HEADERS FOR TRANSACTIONS -->
  <tr class="table-light text-center small border-top">
    <th>Unique_ID</th>
    <th>Date</th>
    <th>Buy/Sale</th>
    <th>Qty</th>
    <th>T. Amount</th>
    <th>Rate</th>
    <th>R. Profit</th>
    <th>Broker No.</th>
  </tr>

</thead>

<tbody>
  {% for r in rows %}
  <tr class="{% if r.transaction|lower == 'buy' %}bg-success bg-opacity-10{% elif r.transaction|lower == 'sale' %}bg-danger bg-opacity-10{% else %}bg-white{% endif %}">
    <td class="small text-start">{{ r.unique_id }}</td>    <!-- align left -->
    <td class="text-start">{{ r.date|date:"Y-m-d" }}</td> <!-- align left -->
    <td>{{ r.transaction }}</td>
    <td class="text-end">{{ r.qty }}</td>
    <td class="text-end">{{ r.t_amount|floatformat:2 }}</td>
    <td class="text-end">{{ r.rate|floatformat:2 }}</td>
    <td class="text-end">{{ r.profit|floatformat:2 }}</td>
    <td>{{ r.broker }}</td>
  </tr>
  {% endfor %}
</tbody>


    </table>
  </div>
</main>


    <!-- Information Panel (Right) -->
    <aside class="col-12 col-md-3">
      <div class="border p-2 mb-3 bg-light">
        <h5 class="text-center">Information Panel</h5>
        <table class="table table-borderless small">
          <tr><th>Symbol</th><td>{{ current_symbol }}</td></tr>
          <tr><th>Volume</th><td>{{ summary.closing_qty }}</td></tr>
          <tr><th>Cost</th><td>{{ summary.closing_rate|floatformat:2 }}</td></tr>
          <tr><th>LTP ({{ today|date:"Y-m-d" }})</th><td>{{ summary.ltp|floatformat:2 }}</td></tr>
          <tr><th>BEP (Rs.)</th><td>{{ summary.bep|floatformat:2 }}</td></tr>
          <tr><th>Realized P/L</th><td>{{ summary.realized_profit|floatformat:2 }}</td></tr>
          <tr><th>Unrealized P/L</th><td>{{ summary.unrealized_profit|floatformat:2 }}</td></tr>
          <tr><th>Total Profit</th><td>{{ summary.realized_profit|add:summary.unrealized_profit|floatformat:2 }}</td></tr>
        </table>
      </div>
      <div class="border p-2 small">
        <table class="table table-borderless mb-0">
          <tr><th>Total Book Value</th><td>{{ summary.total_book_value|floatformat:2 }}</td></tr>
          <tr><th>Total Market Value</th><td>{{ summary.total_market_value|floatformat:2 }}</td></tr>
          <tr><th>Total Realized Profit</th><td>{{ summary.total_realized_profit|floatformat:2 }}</td></tr>
          <tr><th>Total Unrealized Profit</th><td>{{ summary.total_unrealized_profit|floatformat:2 }}</td></tr>
          <tr><th>Total Profit</th><td>{{ summary.total_realized_profit|add:summary.total_unrealized_profit|floatformat:2 }}</td></tr>
          <tr class="bg-info text-white fw-bold"><th>NAV</th><td>{{ summary.nav|floatformat:2 }}</td></tr>
        </table>
      </div>
    </aside>

  </div>
</div>
{% endblock %}
