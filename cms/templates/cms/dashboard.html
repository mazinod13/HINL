{% extends "cms/base.html" %}
{% block content %}
<div style="display: flex;">

  <!-- Sidebar Navigation -->
  <div style="width: 200px; background-color: #f5f5f5; padding: 1rem;">
    <h4>Symbols</h4>
    <ul style="list-style: none; padding-left: 0;">
      {% for sym in symbols %}
        <li style="margin: 0.5rem 0;">
          <a href="{% url 'cms:dashboard_detail' sym %}" style="{% if sym == current_symbol %}font-weight: bold;{% endif %}">
            {{ sym }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Dashboard Content -->
  <div style="flex-grow: 1; padding: 1rem;">
    <h1>Dashboard - {{ current_symbol }}</h1>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Date</th><th>Transaction</th><th>Qty</th><th>Amount</th><th>Rate</th>
            <th>Op.QTY</th><th>Op.RATE</th><th>Op.AMOUNT</th>
            <th>P.QTY</th><th>P.RATE</th><th>P.AMOUNT</th>
            <th>S.QTY</th><th>S.RATE</th><th>S.AMOUNT</th>
            <th>CONSUMPTION</th><th>PROFIT</th>
            <th>Cl.QTY</th><th>Cl.RATE</th><th>Cl.AMOUNT</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr>
            <td contenteditable="true" class="editable" data-id="{{ row.id }}" data-field="date">{{ row.date }}</td>
            <td contenteditable="true" class="editable" data-id="{{ row.id }}" data-field="transaction">{{ row.transaction }}</td>
            <td contenteditable="true" class="editable" data-id="{{ row.id }}" data-field="qty">{{ row.qty }}</td>
            <td contenteditable="true" class="editable" data-id="{{ row.id }}" data-field="t_amount">{{ row.t_amount }}</td>
            <td contenteditable="true" class="editable" data-id="{{ row.id }}" data-field="rate">{{ row.rate }}</td>
            <td>{{ row.op_qty }}</td><td>{{ row.op_rate }}</td><td>{{ row.op_amount }}</td>
            <td>{{ row.p_qty }}</td><td>{{ row.p_rate }}</td><td>{{ row.p_amount }}</td>
            <td>{{ row.s_qty }}</td><td>{{ row.s_rate }}</td><td>{{ row.s_amount }}</td>
            <td>{{ row.consumption }}</td><td>{{ row.profit }}</td>
            <td>{{ row.cl_qty }}</td><td>{{ row.cl_rate }}</td><td>{{ row.cl_amount }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <button id="save-changes" class="btn btn-primary">Save Changes</button>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

const editedItems = [];
$('.editable').on('focusout', function () {
  const id = $(this).data('id');
  const field = $(this).data('field');
  const value = $(this).text();
  editedItems.push({ id: id, field: field, value: value });
});

$('#save-changes').click(function () {
  $.ajax({
    url: window.location.href,
    type: "POST",
    headers: { 'X-CSRFToken': csrftoken },
    contentType: "application/json",
    data: JSON.stringify({ items: editedItems }),
    success: function (response) {
      console.log("Saved:", response);
    }
  });
});
</script>
{% endblock %}
